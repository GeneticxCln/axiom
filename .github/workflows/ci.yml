name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  fmt:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - uses: Swatinem/rust-cache@v2
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libwayland-dev libxkbcommon-dev libinput-dev libdrm-dev libgbm-dev
      - name: cargo fmt
        run: cargo fmt --all -- --check

  clippy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libwayland-dev libxkbcommon-dev libinput-dev libdrm-dev libgbm-dev
      - name: cargo clippy (strict lib, no default features)
        env:
          RUSTFLAGS: "-D warnings"
        run: |
          cargo clippy --lib --no-default-features -- -D warnings
      - name: cargo clippy (strict lib, smithay only)
        env:
          RUSTFLAGS: "-D warnings"
        run: |
          cargo clippy --lib --no-default-features --features smithay -- -D warnings
      - name: cargo clippy (all targets, fail on warnings)
        env:
          RUSTFLAGS: "-D warnings"
        run: |
          for FEATURES in "" "--no-default-features --features smithay" "--no-default-features --features smithay,wgpu-present"; do \
            echo "Running clippy for: $FEATURES"; \
            cargo clippy --all-targets $FEATURES -- -D warnings; \
          done

  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        features:
          - ""
          - "--no-default-features --features smithay"
          - "--no-default-features --features smithay,wgpu-present"
          - "--no-default-features --features real-compositor"
          - "--no-default-features --features real-compositor,wgpu-present"
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libwayland-dev libxkbcommon-dev libinput-dev libdrm-dev libgbm-dev xvfb
      - name: cargo test
        run: |
          cargo test --all ${{ matrix.features }} --no-fail-fast

  deny:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Install cargo-deny
        run: cargo install cargo-deny --locked
      - name: Run cargo-deny (advisories)
        run: cargo deny check advisories

  future-incompat:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Report future incompatibilities
        run: cargo report future-incompatibilities --id 1

  integration-minimal:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libwayland-dev wayland-protocols xvfb build-essential
      - name: Run minimal Wayland server integration test
        run: |
          xvfb-run -a bash ./test_wayland_server.sh
      - name: Upload logs (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: minimal-server-logs
          path: |
            test_logs/**
            *.log
            tests/*.log

  integration-shm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Install system dependencies (Wayland + X11 + build tools)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config build-essential xvfb \
            wayland-protocols libwayland-dev libxkbcommon-dev \
            libx11-dev libxi-dev libxcursor-dev libxrandr-dev libx11-xcb-dev \
            libgl1-mesa-dev
      - name: Run SHM rendering validation (xvfb)
        run: |
          xvfb-run -a bash ./test_shm_rendering.sh
      - name: Upload SHM test logs (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: shm-rendering-logs
          path: |
            test_logs_shm/**
            test_logs/**
            *.log
            tests/*.log
