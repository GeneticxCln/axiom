name: Axiom CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    strategy:
      matrix:
        rust:
          - stable
          - beta
          - nightly
        features:
          - default
          - no-effects
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: ${{ matrix.rust }}
        components: rustfmt, clippy
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libwayland-dev \
          libxkbcommon-dev \
          libegl1-mesa-dev \
          libdrm-dev \
          libgbm-dev \
          libinput-dev \
          libsystemd-dev \
          libdbus-1-dev \
          pkg-config \
          xvfb
    
    - name: Cache cargo registry
      uses: actions/cache@v3
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache cargo index
      uses: actions/cache@v3  
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache cargo build
      uses: actions/cache@v3
      with:
        path: target
        key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

    - name: Check formatting
      run: cargo fmt -- --check
      
    - name: Run clippy
      run: cargo clippy --all-targets --all-features -- -D warnings
      
    - name: Run tests
      run: |
        # Run tests with virtual display for graphics operations
        xvfb-run -a cargo test --verbose --all-features
        
    - name: Run integration tests
      run: |
        # Test IPC communication
        xvfb-run -a cargo test --test integration_tests --all-features
        
    - name: Build release binary
      run: cargo build --release --verbose
      
    - name: Test release binary
      run: |
        # Quick smoke test of the release binary
        timeout 10s ./target/release/axiom --help || true
        
  memory-safety:
    name: Memory Safety
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libwayland-dev \
          libxkbcommon-dev \
          libegl1-mesa-dev \
          libdrm-dev \
          libgbm-dev \
          libinput-dev \
          libsystemd-dev \
          libdbus-1-dev \
          pkg-config \
          valgrind
    
    - name: Install cargo-valgrind
      run: cargo install cargo-valgrind
      
    - name: Run valgrind tests
      run: |
        # Run subset of tests under valgrind for memory leak detection
        cargo valgrind test --bin axiom --lib workspace config effects
        
  performance:
    name: Performance Benchmarks  
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libwayland-dev \
          libxkbcommon-dev \
          libegl1-mesa-dev \
          libdrm-dev \
          libgbm-dev \
          libinput-dev \
          libsystemd-dev \
          libdbus-1-dev \
          pkg-config \
          xvfb
    
    - name: Run benchmarks
      run: |
        xvfb-run -a cargo bench --all-features
        
    - name: Performance regression check
      run: |
        # Compare benchmark results with baseline (implement this when we have baseline)
        echo "Benchmark results logged for performance tracking"

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      
    - name: Install cargo-audit
      run: cargo install cargo-audit
      
    - name: Run security audit
      run: cargo audit
      
    - name: Check for vulnerable dependencies
      run: |
        cargo audit --deny warnings || echo "Security warnings found"

  package:
    name: Test Packaging
    runs-on: ${{ matrix.os }}
    needs: test
    strategy:
      matrix:
        os: [ubuntu-latest, fedora-latest]
        include:
          - os: ubuntu-latest
            package_type: deb
          - os: fedora-latest  
            package_type: rpm
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install system dependencies (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libwayland-dev \
          libxkbcommon-dev \
          libegl1-mesa-dev \
          libdrm-dev \
          libgbm-dev \
          libinput-dev \
          libsystemd-dev \
          libdbus-1-dev \
          pkg-config
    
    - name: Test package creation
      run: |
        # Create basic package structure (to be implemented)
        echo "Package creation test for ${{ matrix.package_type }}"
        
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        components: llvm-tools-preview
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libwayland-dev \
          libxkbcommon-dev \
          libegl1-mesa-dev \
          libdrm-dev \
          libgbm-dev \
          libinput-dev \
          libsystemd-dev \
          libdbus-1-dev \
          pkg-config \
          xvfb
    
    - name: Install grcov
      run: cargo install grcov
      
    - name: Generate coverage data
      run: |
        export CARGO_INCREMENTAL=0
        export RUSTFLAGS="-Zprofile -Ccodegen-units=1 -Cinline-threshold=0 -Clink-dead-code -Coverflow-checks=off -Cpanic=abort -Zpanic_abort_tests"
        export RUSTDOCFLAGS="-Zprofile -Ccodegen-units=1 -Cinline-threshold=0 -Clink-dead-code -Coverflow-checks=off -Cpanic=abort -Zpanic_abort_tests"
        xvfb-run -a cargo +nightly test
        grcov . -s . --binary-path ./target/debug/ -t html --branch --ignore-not-existing -o ./coverage/
        
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        directory: ./coverage
        fail_ci_if_error: true
